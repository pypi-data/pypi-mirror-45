var Channel,Component,channel,component,i,len,send;Channel=class Channel{constructor(url,options={}){this.on=this.on.bind(this);this.url=url;this.retry_interval=options.retry_interval||1000;this.online=false;this.callbacks={};}
on(event_name,callback){return this.callbacks[event_name]=callback;}
trigger(event_name,...args){var base;return typeof(base=this.callbacks)[event_name]==="function"?base[event_name](...args):void 0;}
open(){var protocol,ref;if(!(typeof navigator!=="undefined"&&navigator!==null?navigator.onLine:void 0)&&(this.retry_interval!=null)){setTimeout((()=>{return this.open();}),this.retry_interval);}
if((ref=this.websocket)!=null){ref.close();}
if(window.location.protocol==='https:'){protocol='wss://';}else{protocol='ws://';}
this.websocket=new WebSocket(`${protocol}${window.location.host}${this.url}`);this.websocket.onopen=(e)=>{this.online=true;return this.trigger('open');};this.websocket.onclose=(e)=>{this.online=false;this.trigger('close');if(this.retry_interval!=null){return setTimeout((()=>{return this.open();}),this.retry_interval);}};return this.websocket.onmessage=(e)=>{var data;data=JSON.parse(e.data);return this.trigger('message',data);};}
send(command,payload){var data;data={command:command,payload:payload};if(this.online){try{return this.websocket.send(JSON.stringify(data));}catch(error){return console.log('Failed sending');}}}};channel=new Channel('/reactor');channel.open();channel.on('open',function(){var el,i,len,ref,results;console.log('ON-LINE');ref=document.querySelectorAll(reactor_components.join(','));results=[];for(i=0,len=ref.length;i<len;i++){el=ref[i];results.push(el.connect({echo_render:true}));}
return results;});channel.on('message',function({type,id,html}){var el,ref;console.log('<<< ',type.toUpperCase(),id);if(type==='render'){el=document.getElementById(id);if(el!=null){return window.requestAnimationFrame(function(){var ref;morphdom(el,html,{onBeforeElUpdated:function(fromEl,toEl){var state_changed;state_changed=fromEl!==el&&fromEl.getAttribute('state')!==toEl.getAttribute('state');if(state_changed){toEl.connect();}
return true;}});return(ref=el.querySelector('[focus]'))!=null?ref.focus():void 0;});}}else if(type==='remove'){return(ref=document.getElementById(id))!=null?ref.remove():void 0;}});for(i=0,len=reactor_components.length;i<len;i++){component=reactor_components[i];Component=class Component extends HTMLElement{constructor(){super();this.tag_name=this.tagName.toLowerCase();}
connectedCallback(){return this.connect();}
disconnectedCallback(){return channel.send('leave',{id:this.id,tag_name:this.tag_name});}
connect(options={}){var state;if(options.echo_render==null){options.echo_render=false;}
console.log('>>> JOIN',this.tag_name);state=JSON.parse(this.getAttribute('state'));return channel.send('join',{tag_name:this.tag_name,state:state,echo_render:options.echo_render});}
dispatch(name,args){var k,state,v;state=this.serialize();for(k in args){v=args[k];state[k]=v;}
console.log('>>> USER_EVENT',this.tag_name,name,state);return channel.send('user_event',{tag_name:this.tag_name,name:name,state:state});}
serialize(state){var checked,j,len1,name,ref,type,value;if(state==null){state={id:this.id};}
ref=this.querySelectorAll('[name]');for(j=0,len1=ref.length;j<len1;j++){({type,name,value,checked}=ref[j]);state[name]=type==='checkbox'?checked:value;}
return state;}};customElements.define(component,Component);}
send=function(element,name,args){while(element){if(element.dispatch!=null){return element.dispatch(name,args||{});}
element=element.parentElement;}};