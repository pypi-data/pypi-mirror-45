- hosts:
    - master
    - slave
  tasks:
    - include_role:
        name: iserver
        tasks_from: iperf_start
      when: bandwidth | d(false)

- hosts:
    - master
    - slave
  serial: 1
  tasks:
    - include_role:
        name: iserver
        tasks_from: iperf_test
      when: bandwidth | d(false)

- hosts:
    - master
    - slave
  tasks:
    - include_role:
        name: iserver
        tasks_from: ping_test
      when: latency | d(false)
    - include_role:
        name: iserver
        tasks_from: dd_test
      when: io | d(false)

- hosts:
    - master
    - slave
  tasks:
    - include_role:
        name: iserver
        tasks_from: iperf_stop
      when: bandwidth | d(false)

- hosts:
    localhost
  become: false
  tasks:
    - name: Gathering test result
      set_fact:
        bd_result: "{{ bd_result | d({}) | combine( { item: hostvars[item].bd_res | d() } ) }}"
        lt_result: "{{ lt_result | d({}) | combine( { item: hostvars[item].lt_res | d() } ) }}"
        io_result: "{{ io_result | d({}) | combine( { item: hostvars[item].io_res | d() } ) }}"
      with_items:
        - "{{ groups.master }}"
        - "{{ groups.slave }}"

    - name: Bandwidth test result
      debug:
        var: bd_result
      when:
        - bandwidth | d(false)
    - name: Latency test result
      debug:
        var: lt_result
      when:
        - latency | d(false)
    - name: Disk IO test result
      debug:
        var: io_result
      when:
        - io | d(false)
