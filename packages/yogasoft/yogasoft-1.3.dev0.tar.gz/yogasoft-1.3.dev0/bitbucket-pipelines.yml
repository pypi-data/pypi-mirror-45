image: alpine:latest
pipelines:
  default:
    - step:
        caches:
          - pip
        script:
          - apk add --no-cache gcc python3-dev make zlib-dev jpeg-dev bash curl postgresql-dev musl-dev libffi-dev openssl-dev dbus firefox-esr fontconfig python3 ttf-freefont xvfb
          - wget https://github.com/mozilla/geckodriver/releases/download/v0.24.0/geckodriver-v0.24.0-linux64.tar.gz
          - tar -zxvf geckodriver-v0.24.0-linux64.tar.gz
          - chmod +x geckodriver
          - mv geckodriver /usr/local/bin/
          - pip3 install --upgrade pip
          - pip3 install -r requirements.txt
          - python3 manage.py test --verbosity=2
        services:
          - postgres
          - redis
definitions:
  services:
    postgres:
      image: postgres
      environment:
        POSTGRES_PASSWORD: 'yogasoft'
    redis:
      image: redis
